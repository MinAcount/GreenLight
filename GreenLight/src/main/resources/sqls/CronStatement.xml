<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.green.light.model.mapper.CronDaoImpl">

<resultMap type="com.green.light.vo.VacationVo" id="VacVo">
	<result property="vacno" column="VACNO"/>
	<result property="id" column="ID"/>
	<result property="start_day" column="START_DAY"/>
	<result property="end_day" column="END_DAY"/>
	<result property="half" column="HALF"/>
	<result property="getsu" column="GETSU"/>
	<result property="bigo" column="BIGO"/>
	
	<result property="used_leave" column="used_leave"/>
	<result property="remaining_leave" column="remaining_leave"/>
	
	<collection property="empVo" resultMap="EmployeeVo" />
</resultMap>

<resultMap type="com.green.light.vo.EmployeeVo" id="EmployeeVo">
	<result property="id" column="ID" />
	<result property="name" column="NAME" />
	<result property="phone" column="PHONE" />
	<result property="birthday" column="BIRTHDAY" />
	<result property="gender" column="GENDER" />
	<result property="address" column="ADDRESS" />
	<result property="deptno" column="DEPTNO" />
	<result property="spot" column="SPOT" />
	<result property="position" column="POSITION" />
	<result property="estatus" column="ESTATUS" />
	<result property="join_day" column="JOIN_DAY" />
	<result property="exit_day" column="EXIT_DAY" />
	<result property="etype" column="ETYPE" />
	<result property="leave" column="LEAVE" />
	<result property="auth" column="AUTH" />
	<result property="profile" column="PROFILE" />
</resultMap>

<!-- 자동퇴근처리 autoCompleteWorkTime() -->
<update id="autoCompleteWorkTime">
UPDATE ATTENDANCE
SET 
    OUT_DATE = TO_DATE(TO_CHAR(IN_DATE, 'YYYY-MM-DD') || ' 18:00:00', 'YYYY-MM-DD HH24:MI:SS'),
    ATT_STATUS = CASE WHEN TO_CHAR(IN_DATE, 'HH24:MI') > '09:10' THEN '지각'
            ELSE '정상' END WHERE OUT_DATE IS NULL AND ATT_STATUS IS NULL
</update>

<select id="getOverVacation" resultMap="VacVo">
<![CDATA[
SELECT E.ID, E.NAME, E.JOIN_DAY,
    E.SPOT, E.LEAVE,
    E.LEAVE - SUM(NVL(CASE WHEN V.START_DAY >= ADD_MONTHS(CURRENT_TIMESTAMP, -12) AND 
                                V.START_DAY < TRUNC(CURRENT_TIMESTAMP)
                            THEN V.GETSU ELSE 0 END, 0))  Remaining_Leave
FROM EMPLOYEE E
LEFT JOIN VACATION V ON E.ID = V.ID
WHERE TO_CHAR(E.JOIN_DAY, 'MM-DD') = TO_CHAR(CURRENT_TIMESTAMP, 'MM-DD')
GROUP BY E.ID, E.NAME, E.JOIN_DAY, E.SPOT, E.LEAVE
HAVING E.LEAVE - SUM(NVL(CASE WHEN V.START_DAY >= ADD_MONTHS(CURRENT_TIMESTAMP, -12) AND 
                                V.START_DAY < TRUNC(CURRENT_TIMESTAMP)
                            THEN V.GETSU ELSE 0 END, 0)) < 0
]]>
</select>

<insert id="insertOverVacation" parameterType="java.util.Map">
	<selectKey keyProperty="seq" resultType="java.lang.String" order="BEFORE">
		SELECT VACATION_SEQ.NEXTVAL FROM dual	
	</selectKey>
INSERT INTO VACATION (VACNO, ID, START_DAY, END_DAY,  GETSU, BIGO)
VALUES (#{seq}, #{id}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, #{getsu}, '조정')
</insert>






</mapper>
 